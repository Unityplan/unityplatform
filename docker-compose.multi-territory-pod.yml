# Multi-Territory Pod Docker Compose
# Purpose: Template for pods hosting multiple territories
# Example: Europe pod with Germany, France, Spain

version: '3.8'

name: pod-${POD_ID}

services:
  # ===================================================================
  # PostgreSQL - Multi-Database Setup
  # ===================================================================
  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: service-postgres-${POD_ID}
    hostname: service-postgres-${POD_ID}
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # Primary database (first territory)
      POSTGRES_DB: ${POSTGRES_DB_DE:-unityplan_de}
      # Pass territory configs for init script
      TERRITORY_DE_TIMEZONE: ${TERRITORY_DE_TIMEZONE}
      TERRITORY_DE_LOCALE: ${TERRITORY_DE_LOCALE}
      TERRITORY_DE_LANGUAGE: ${TERRITORY_DE_LANGUAGE}
      TERRITORY_FR_TIMEZONE: ${TERRITORY_FR_TIMEZONE}
      TERRITORY_FR_LOCALE: ${TERRITORY_FR_LOCALE}
      TERRITORY_FR_LANGUAGE: ${TERRITORY_FR_LANGUAGE}
      TERRITORY_ES_TIMEZONE: ${TERRITORY_ES_TIMEZONE}
      TERRITORY_ES_LOCALE: ${TERRITORY_ES_LOCALE}
      TERRITORY_ES_LANGUAGE: ${TERRITORY_ES_LANGUAGE}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./pods/${POD_ID}/init-multi-territory.sh:/docker-entrypoint-initdb.d/init-multi-territory.sh:ro
    networks:
      - pod-${POD_ID}-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===================================================================
  # Redis - Shared with Key Prefixing
  # ===================================================================
  redis:
    image: redis:7-alpine
    container_name: service-redis-${POD_ID}
    hostname: service-redis-${POD_ID}
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_dev_password}
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis-data:/data
    networks:
      - pod-${POD_ID}-net
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ===================================================================
  # NATS - Clustered Messaging
  # ===================================================================
  nats:
    image: nats:2.10-alpine
    container_name: service-nats-${POD_ID}
    hostname: service-nats-${POD_ID}
    command:
      - "--cluster_name=unityplan-global"
      - "--cluster=nats://0.0.0.0:6222"
      - "--routes=${NATS_ROUTES}"
      - "--http_port=8222"
      - "--jetstream"
      - "--store_dir=/data"
      - "--max_payload=8MB"
    ports:
      - "${NATS_CLIENT_PORT}:4222"
      - "${NATS_CLUSTER_PORT}:6222"
      - "${NATS_MONITOR_PORT}:8222"
    volumes:
      - nats-data:/data
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    restart: unless-stopped

  # ===================================================================
  # IPFS - Shared Content Storage
  # ===================================================================
  ipfs:
    image: ipfs/kubo:latest
    container_name: service-ipfs-${POD_ID}
    hostname: service-ipfs-${POD_ID}
    environment:
      IPFS_PROFILE: server
    ports:
      - "${IPFS_API_PORT}:5001"
      - "${IPFS_GATEWAY_PORT}:8080"
      - "${IPFS_SWARM_PORT}:4001"
    volumes:
      - ipfs-data:/data/ipfs
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    restart: unless-stopped

  # ===================================================================
  # Matrix Synapse - Federation Server (Multi-Territory)
  # ===================================================================
  # Note: For production, consider separate Matrix instances per territory
  # For now, single instance with multiple server names via config
  matrix:
    image: matrixdotorg/synapse:latest
    container_name: service-matrix-${POD_ID}
    hostname: service-matrix-${POD_ID}
    environment:
      SYNAPSE_SERVER_NAME: ${MATRIX_SERVER_NAME_DE}  # Primary
      SYNAPSE_REPORT_STATS: "no"
    ports:
      - "${MATRIX_PORT}:8008"
    volumes:
      - matrix-data:/data
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    restart: unless-stopped

  # ===================================================================
  # EXPORTERS - Monitoring
  # ===================================================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: monitoring-postgres-exporter-${POD_ID}
    hostname: monitoring-postgres-exporter-${POD_ID}
    environment:
      # Monitor all three databases
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@service-postgres-${POD_ID}:5432/unityplan_de?sslmode=disable"
    ports:
      - "${POSTGRES_EXPORTER_PORT}:9187"
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    depends_on:
      - postgres
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: monitoring-redis-exporter-${POD_ID}
    hostname: monitoring-redis-exporter-${POD_ID}
    environment:
      REDIS_ADDR: service-redis-${POD_ID}:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    ports:
      - "${REDIS_EXPORTER_PORT}:9121"
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    depends_on:
      - redis
    restart: unless-stopped

  nats-exporter:
    image: natsio/prometheus-nats-exporter:latest
    container_name: monitoring-nats-exporter-${POD_ID}
    hostname: monitoring-nats-exporter-${POD_ID}
    command:
      - "-varz"
      - "-channelz"
      - "-connz"
      - "-routez"
      - "-subz"
      - "http://service-nats-${POD_ID}:8222"
    ports:
      - "${NATS_EXPORTER_PORT}:7777"
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    depends_on:
      - nats
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:latest
    container_name: monitoring-node-exporter-${POD_ID}
    hostname: monitoring-node-exporter-${POD_ID}
    command:
      - '--path.rootfs=/host'
    ports:
      - "${NODE_EXPORTER_PORT}:9100"
    volumes:
      - '/:/host:ro,rslave'
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: monitoring-cadvisor-${POD_ID}
    hostname: monitoring-cadvisor-${POD_ID}
    ports:
      - "${CADVISOR_PORT}:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks:
      - pod-${POD_ID}-net
      - mesh-network
    privileged: true
    devices:
      - /dev/kmsg
    restart: unless-stopped

# ===================================================================
# NETWORKS
# ===================================================================
networks:
  pod-${POD_ID}-net:
    name: pod-${POD_ID}-net
    driver: bridge
  
  mesh-network:
    external: true
    name: unityplan-mesh-network

# ===================================================================
# VOLUMES
# ===================================================================
volumes:
  postgres-data:
    name: ${POD_ID}-postgres-data
  redis-data:
    name: ${POD_ID}-redis-data
  nats-data:
    name: ${POD_ID}-nats-data
  ipfs-data:
    name: ${POD_ID}-ipfs-data
  matrix-data:
    name: ${POD_ID}-matrix-data
